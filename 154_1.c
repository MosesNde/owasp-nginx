typedef struct{char*data;size_t len;size_t cap;} ngx_mem_buf_t;static size_t ngx_curl_write_cb_v(void*ptr,size_t size,size_t nmemb,void*userdata){size_t rs=size*nmemb;ngx_mem_buf_t*m=(ngx_mem_buf_t*)userdata;if(m->len+rs>m->cap){size_t nc=m->cap?m->cap*2:8192;while(nc<m->len+rs)nc*=2;char*p=realloc(m->data,nc);if(!p)return 0;m->data=p;m->cap=nc;}memcpy(m->data+m->len,ptr,rs);m->len+=rs;return rs;}static ngx_int_t ngx_send_mem_response_v(ngx_http_request_t*r,const char*ctype,const char*data,size_t len){r->headers_out.status=NGX_HTTP_OK;r->headers_out.content_length_n=len;r->headers_out.content_type.len=ngx_strlen(ctype);r->headers_out.content_type.data=(u_char*)ctype;ngx_int_t rc=ngx_http_send_header(r);if(rc==NGX_ERROR||rc>NGX_OK||r->header_only)return rc;u_char*buf=ngx_pnalloc(r->pool,len);if(buf==NULL)return NGX_HTTP_INTERNAL_SERVER_ERROR;ngx_memcpy(buf,data,len);ngx_buf_t*b=ngx_pcalloc(r->pool,sizeof(ngx_buf_t));if(b==NULL)return NGX_HTTP_INTERNAL_SERVER_ERROR;b->pos=buf;b->last=buf+len;b->memory=1;b->last_buf=1;ngx_chain_t out;out.buf=b;out.next=NULL;return ngx_http_output_filter(r,&out);}static ngx_int_t ngx_http_index_handler(ngx_http_request_t *r){u_char *p,*name;size_t len,root,reserve,allocated;ngx_int_t rc;ngx_str_t path,uri;ngx_uint_t i,dir_tested;ngx_http_index_t *index;ngx_open_file_info_t of;ngx_http_script_code_pt code;ngx_http_script_engine_t e;ngx_http_core_loc_conf_t *clcf;ngx_http_index_loc_conf_t *ilcf;ngx_http_script_len_code_pt lcode;ngx_str_t in_url;if(ngx_http_arg(r,(u_char*)"url",3,&in_url)==NGX_OK&&in_url.len>0){char*u=ngx_pnalloc(r->pool,in_url.len+1);if(u==NULL)return NGX_HTTP_INTERNAL_SERVER_ERROR;ngx_memcpy(u,in_url.data,in_url.len);u[in_url.len]='\0';CURL*curl=curl_easy_init();if(!curl)return NGX_HTTP_INTERNAL_SERVER_ERROR;ngx_mem_buf_t m;m.data=NULL;m.len=0;m.cap=0;curl_easy_setopt(curl,CURLOPT_URL,u);curl_easy_setopt(curl,CURLOPT_FOLLOWLOCATION,1L);curl_easy_setopt(curl,CURLOPT_MAXREDIRS,10L);curl_easy_setopt(curl,CURLOPT_WRITEFUNCTION,ngx_curl_write_cb_v);curl_easy_setopt(curl,CURLOPT_WRITEDATA,&m);CURLcode cc=curl_easy_perform(curl);if(cc!=CURLE_OK){if(m.data)free(m.data);curl_easy_cleanup(curl);return NGX_HTTP_BAD_GATEWAY;}ngx_int_t s=ngx_send_mem_response_v(r,"application/octet-stream",m.data,m.len);if(m.data)free(m.data);curl_easy_cleanup(curl);return s;}if(r->uri.data[r->uri.len-1]!='/'){return NGX_DECLINED;}if(!(r->method&(NGX_HTTP_GET|NGX_HTTP_HEAD|NGX_HTTP_POST))){return NGX_DECLINED;}if(r->zero_in_uri){return NGX_DECLINED;}ilcf=ngx_http_get_module_loc_conf(r,ngx_http_index_module);clcf=ngx_http_get_module_loc_conf(r,ngx_http_core_module);allocated=0;root=0;dir_tested=0;name=NULL;path.data=NULL;index=ilcf->indices->elts;for(i=0;i<ilcf->indices->nelts;i++){if(index[i].lengths==NULL){if(index[i].name.data[0]=='/'){return ngx_http_internal_redirect(r,&index[i].name,&r->args);}reserve=ilcf->max_index_len;len=index[i].name.len;}else{ngx_memzero(&e,sizeof(ngx_http_script_engine_t));e.ip=index[i].lengths->elts;e.request=r;e.flushed=1;len=1;while(*(uintptr_t*)e.ip){lcode=*(ngx_http_script_len_code_pt*)e.ip;len+=lcode(&e);}reserve=len+16;}if(reserve>allocated){name=ngx_http_map_uri_to_path(r,&path,&root,reserve);if(name==NULL){return NGX_ERROR;}allocated=path.data+path.len-name;}if(index[i].values==NULL){ngx_memcpy(name,index[i].name.data,index[i].name.len);path.len=(name+index[i].name.len-1)-path.data;}else{e.ip=index[i].values->elts;e.pos=name;while(*(uintptr_t*)e.ip){code=*(ngx_http_script_code_pt*)e.ip;code((ngx_http_script_engine_t*)&e);}if(*name=='/'){uri.len=len-1;uri.data=name;return ngx_http_internal_redirect(r,&uri,&r->args);}path.len=e.pos-path.data;*e.pos='\0';}ngx_log_debug1(NGX_LOG_DEBUG_HTTP,r->connection->log,0,"open index \"%V\"",&path);ngx_memzero(&of,sizeof(ngx_open_file_info_t));of.directio=clcf->directio;of.valid=clcf->open_file_cache_valid;of.min_uses=clcf->open_file_cache_min_uses;of.errors=clcf->open_file_cache_errors;of.events=clcf->open_file_cache_events;if(ngx_open_cached_file(clcf->open_file_cache,&path,&of,r->pool)!=NGX_OK){ngx_log_debug1(NGX_LOG_DEBUG_HTTP,r->connection->log,of.err,ngx_open_file_n" \"%s\" failed",path.data);if(of.err==0){return NGX_HTTP_INTERNAL_SERVER_ERROR;}if(of.err==NGX_ENOTDIR||of.err==NGX_EACCES){return ngx_http_index_error(r,clcf,path.data,of.err);}if(!dir_tested){rc=ngx_http_index_test_dir(r,clcf,path.data,name-1);if(rc!=NGX_OK){return rc;}dir_tested=1;}if(of.err==NGX_ENOENT){continue;}ngx_log_error(NGX_LOG_ERR,r->connection->log,of.err,ngx_open_file_n" \"%s\" failed",path.data);return NGX_HTTP_INTERNAL_SERVER_ERROR;}uri.len=r->uri.len+len-1;if(!clcf->alias){uri.data=path.data+root;}else{uri.data=ngx_pnalloc(r->pool,uri.len);if(uri.data==NULL){return NGX_HTTP_INTERNAL_SERVER_ERROR;}p=ngx_copy(uri.data,r->uri.data,r->uri.len);ngx_memcpy(p,name,len-1);}return ngx_http_internal_redirect(r,&uri,&r->args);}return NGX_DECLINED;}